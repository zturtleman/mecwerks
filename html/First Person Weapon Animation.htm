<SCRIPT SRC="http://ads.gamespy.com/jserver/SITE=PQ/AREA=HOSTED/GENRE=ACTION/TIER=3/AAMSZ=PRESTITIAL?304482703"></SCRIPT><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0051)http://www.quarantinemod.net/animation_tutorial.asp -->
<HTML><HEAD><TITLE>Quarantine Q3 Mod -- The Official Site</TITLE>
<META content="text/html; charset=iso-8859-1" http-equiv=Content-Type>
<META content="MSHTML 5.00.2614.3500" name=GENERATOR></HEAD>
<BODY aLink=#ffffff bgColor=#000000 link=#ffffff text=#ffffff vLink=#ffffff>
<TABLE border=0 cellPadding=0 cellSpacing=0 height=153 width="100%">
  <TBODY>
  <TR>
    <TD rowSpan=2 width="6%"><IMG height=250 
      src="First Person Weapon Animation_files/Title_Left.jpg" width=73></TD>
    <TD background="First Person Weapon Animation_files/Title_Main_Filler.jpg" 
    colSpan=3 height=88><IMG height=176 
      src="First Person Weapon Animation_files/Title_Main.jpg" width=727></TD></TR>
  <TR>
    <TD background="First Person Weapon Animation_files/Title_Bottom.jpg" 
    height=10 vAlign=top width="58%"><IMG height=74 
      src="First Person Weapon Animation_files/Title_Bottom.jpg" width=727></TD>
    <TD background="First Person Weapon Animation_files/Title_Bottom_Filler.jpg" 
    height=10 vAlign=top width="36%">&nbsp;</TD></TR></TBODY></TABLE>
<TABLE border=0 cellPadding=0 cellSpacing=0 height=274 width="100%">
  <TBODY>
  <TR>
    <TD align=middle background="" bgColor=#000000 vAlign=top width=150>
      <TABLE align=left 
      background="First Person Weapon Animation_files/Background_Menu.jpg" 
      border=0 cellPadding=0 cellSpacing=0 height=453 width=164>
        <TBODY>
        <TR>
          <TD vAlign=top>
            <P align=left><FONT color=#ffffff size=5><FONT size=4><IMG height=38 
            src="First Person Weapon Animation_files/Menu_MainMenu.jpg" 
            width=144><B><FONT size=3><BR> <A 
            href="http://www.quarantinemod.net/default.asp"><FONT color=#ffffff 
            onmouseout="this.innerHTML = 'news';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'news';&#13;&#10;                   this.style.color = '#FF9900';">news</FONT></A><BR> 
            <A href="http://www.quarantinemod.net/default.asp"><FONT 
            color=#ffffff 
            onmouseout="this.innerHTML = 'about';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'about';&#13;&#10;                   this.style.color = '#FF9900';">about</FONT></A><BR> 
            <A href="http://www.quarantinemod.net/story.asp"><FONT color=#ffffff 
            onmouseout="this.innerHTML = 'story';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'story';&#13;&#10;                   this.style.color = '#FF9900';">story</FONT></A><BR> 
            <A href="http://www.quarantinemod.net/default.asp"><FONT 
            color=#ffffff 
            onmouseout="this.innerHTML = 'files';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'files';&#13;&#10;                   this.style.color = '#FF9900';">files</FONT></A></FONT></B></FONT></FONT><FONT 
            color=#ffffff size=5><FONT size=4><B></B></FONT></FONT></P>
            <P align=left><B><FONT size=3><IMG height=38 
            src="First Person Weapon Animation_files/Menu_Images.jpg" 
            width=144><FONT color=#ffffff><BR></FONT><FONT color=#ffffff 
            size=5><FONT size=4><B><FONT size=3> <A 
            href="http://www.quarantinemod.net/ingame.asp"><FONT color=#ffffff 
            onmouseout="this.innerHTML = 'in game';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'in game';&#13;&#10;                   this.style.color = '#FF9900';">in 
            game</FONT></A><BR> <A 
            href="http://www.quarantinemod.net/default.asp"><FONT color=#ffffff 
            onmouseout="this.innerHTML = 'characters';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'characters';&#13;&#10;                   this.style.color = '#FF9900';">characters</FONT></A><BR> 
            <A href="http://www.quarantinemod.net/weaponmodels.asp"><FONT 
            color=#ffffff 
            onmouseout="this.innerHTML = 'weapons';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'weapons';&#13;&#10;                   this.style.color = '#FF9900';">weapons</FONT></A><BR> 
            <A href="http://www.quarantinemod.net/conceptart.asp"><FONT 
            color=#ffffff 
            onmouseout="this.innerHTML = 'concept art';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'concept art';&#13;&#10;                   this.style.color = '#FF9900';">concept 
            art</FONT></A></FONT></B></FONT></FONT></FONT></B><B><FONT 
            size=3></FONT></B></P>
            <P align=left><B><FONT size=3><IMG height=38 
            src="First Person Weapon Animation_files/Menu_Resources.jpg" 
            width=144><BR><FONT color=#ffffff size=5><FONT size=4><B><FONT 
            size=3> <A href="http://www.quarantinemod.net/conceptart.asp"><FONT 
            color=#ffffff 
            onmouseout="this.innerHTML = 'concept art';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'concept art';&#13;&#10;                   this.style.color = '#FF9900';"></FONT></A></FONT></B></FONT></FONT><A 
            href="http://www.quarantinemod.net/tutorials.asp"><FONT 
            color=#ffffff 
            onmouseout="this.innerHTML = 'tutorials';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'tutorials';&#13;&#10;                   this.style.color = '#FF9900';">tutorials</FONT></A><BR><FONT 
            color=#ffffff size=5><FONT size=4><B><FONT size=3> 
            </FONT></B></FONT></FONT><A 
            href="http://www.quarantinemod.net/default.asp"><FONT color=#ffffff 
            onmouseout="this.innerHTML = 'forums';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'forums';&#13;&#10;                   this.style.color = '#FF9900';">forums</FONT></A><BR></FONT></B></P>
            <P align=left><B><FONT size=3><IMG height=38 
            src="First Person Weapon Animation_files/Menu_Contact.jpg" 
            width=144><BR><FONT color=#ffffff size=5><FONT size=4><B><FONT 
            size=3> </FONT></B></FONT></FONT><A 
            href="mailto:coyote@quarantinemod.net"><FONT color=#ffffff 
            onmouseout="this.innerHTML = 'coyote';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'coyote';&#13;&#10;                   this.style.color = '#FF9900';">coyote</FONT></A></FONT></B><B><FONT 
            size=3><BR><FONT color=#ffffff size=5><FONT size=4><B><FONT size=3> 
            </FONT></B></FONT></FONT><A 
            href="mailto:ishtar@quarantinemod.net"><FONT color=#ffffff 
            onmouseout="this.innerHTML = 'ishtar';&#13;&#10;                  this.style.color = '#FFFFFF';" 
            onmouseover="this.innerHTML = 'ishtar';&#13;&#10;                   this.style.color = '#FF9900';">ishtar</FONT></A></FONT></B></P></TD></TR></TBODY></TABLE></TD>
    <TD vAlign=top width="91%">
      <P align=center><FONT color=#ffffff><B>Tutorials</B></FONT></P><LEFT>
      <P align=center><FONT color=#ffffff>First person animation<BR>By Coyote ( 
      Joseph Williams )<BR><BR>If you use any of this tutorial, give me some 
      props.<BR><BR>Probably the one thing most Quake 3 MODs deal with when they 
      first start out is first person perspectives and how to separate them from 
      the third world view so that you can easily animate the first person and 
      add in hands to the weapon models. While this is not the only way of 
      handling this and not the only reason youd want to do this, this tutorial 
      will step you through the process needed to animate a model in first 
      person view. You will not learn about how to add in additional animations 
      beyond allowing the weapon to fire, though as youll see adding in other 
      animations is extremely easy once everything is set up. Also this tutorial 
      only adds in changes to the shotgun and machinegun, but as you look over 
      the tutorial, this is simple to help keep the tutorial a bit shorter as 
      adding in the entire code block to add all weapons would add another page 
      or so.</FONT></P>
      <P align=left><FONT color=#ffffff><BR><BR>Files well be editing in this 
      tutorial:<BR>game/bg_public.h<BR>cgame/cg_local.h<BR>cgame/cg_players.c<BR>cgame/cg_weapons.c<BR>game/bg_pmove.c<BR><BR><BR>Color 
      Legend:<BR><FONT color=#ff0000>Red : Files and functions that are changed 
      in that step</FONT><BR><FONT color=#0000ff>Blue : Code that I have changed 
      from the original</FONT><BR><FONT color=#00ff00>Green: Code 
      segments</FONT><BR>White: Original code or tutorial text<BR><BR><B>STEP 
      1:</B><BR><BR>Well first thing we need to know is how many animations we 
      would like to perform in first person. The best way to handle this is to 
      create an enumerated data type (this is a type that normal starts counting 
      0, 1, 2, 3, etc) but allows you to have a name that represents each 
      number.<BR><BR><FONT color=#ff0000>Add to file: 
      game/bg_public.h</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR><FONT 
      color=#0000ff>typedef enum 
      {<BR>WP_ANIM_READY,<BR>WP_ANIM_FIRE,<BR>MAX_WEAPON_ANIMATIONS<BR>} 
      wpAnimNumber_t;</FONT><BR><FONT 
      color=#00ff00>----------------------------------------------------------------------</FONT><BR><BR>As 
      you can see this is a rather simple number of animations, to add more you 
      just start adding them under the WP_ANIM_FIRE.<BR><BR><BR><B>STEP 
      2:</B><BR><BR>Next we need a place to be able to store our first person 
      model, the animation frames, and a hand model so that we get a constant 
      appearance across all weapons. There just so happens to be a nice struct 
      called weaponInfo_s that is in the cgame/cg_local.h. This structure is a 
      list of variables for each weapon. We need to add in three variables to 
      it.<BR><BR><FONT color=#ff0000>Add to file: cgame/cg_local.h<BR>Add to 
      struct: weaponInfo_s</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR><FONT 
      color=#0000ff>qhandle_t animModel;<BR>qhandle_t 
      animHandModel;<BR><BR>animation_t 
      animations[MAX_WEAPON_ANIMATIONS];</FONT><BR><FONT 
      color=#00ff00>----------------------------------------------------------------------<BR></FONT><BR><B>STEP 
      3: </B><BR><BR>Now were going to need a way to know which frames were on 
      currently in regard to the current animation. This is a simple addition of 
      a variable to a structure in the cg_local.h file.<BR><BR><FONT 
      color=#ff0000>Add to file: cgame/cg_local.h<BR>Add to struct: 
      playerEntity_t </FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------<BR><FONT 
      color=#0000ff>lerpFrame_t 
      weapon;</FONT><BR>----------------------------------------------------------------------</FONT><BR><BR><BR><BR><B>STEP 
      4: </B><BR>Ok great your saying, we have all these variables and structs 
      and things but how the heck are we going to get the models and the numbers 
      into the game? Fortunately thanks to the CG_ParseAnimationFile function in 
      cg_player.c it was easy to adapt its design to our needs, what the 
      function below does is parse a animation.cfg file that will store 
      beginning frames, number of frames, frames to repeat, and frames per 
      second for each animation, also is a example of a animation.cfg file and 
      what each number means.<BR><BR><FONT color=#ff0000>Add to file: 
      cgame/cg_weapons.c</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT></FONT><FONT 
      color=#ffffff><FONT color=#00ff00><BR><FONT color=#0000ff>/* [QUARANTINE] 
      - Weapon Animations - 
      CG_ParseWeaponAnimFile<BR>==========================<BR>CG_ParseWeaponAnimFile<BR>==========================<BR>*/<BR>static 
      qboolean CG_ParseWeaponAnimFile( const char *filename, weaponInfo_t 
      *weapon ) {<BR>char *text_p;<BR>int len;<BR>int i;<BR>char 
      *token;<BR>float fps;<BR>int skip;<BR>char text[20000];<BR>fileHandle_t 
      f;<BR>animation_t *animations;<BR><BR>animations = 
      weapon-&gt;animations;<BR><BR>// load the file<BR>len = trap_FS_FOpenFile( 
      filename, &amp;f, FS_READ );<BR>if ( len &lt;= 0 ) {<BR>return 
      qfalse;<BR>}<BR>if ( len &gt;= sizeof( text ) - 1 ) {<BR>CG_Printf( "File 
      %s too long\n", filename );<BR>return qfalse;<BR>}<BR>trap_FS_Read( text, 
      len, f );<BR>text[len] = 0;<BR>trap_FS_FCloseFile( f );<BR><BR>// parse 
      the text<BR>text_p = text;<BR>skip = 0; // quite the compiler 
      warning<BR><BR>// read information for each frame<BR>for ( i = 0 ; i &lt; 
      MAX_WEAPON_ANIMATIONS ; i++ ) { <BR>token = COM_Parse( &amp;text_p 
      );<BR>if ( !token ) break;<BR>animations[i].firstFrame = atoi( token 
      );<BR>token = COM_Parse( &amp;text_p );<BR>if ( !token ) 
      break;<BR>animations[i].numFrames = atoi( token ); <BR>token = COM_Parse( 
      &amp;text_p );<BR>if ( !token ) break;<BR>animations[i].loopFrames = atoi( 
      token ); <BR>token = COM_Parse( &amp;text_p );<BR>if ( !token ) 
      break;<BR>fps = atof( token );<BR>if ( fps == 0 ) fps = 
      1;<BR>animations[i].frameLerp = 1000 / fps;<BR>animations[i].initialLerp = 
      1000 / fps;<BR>}<BR>if ( i != MAX_WEAPON_ANIMATIONS ) {<BR>CG_Printf( 
      "Error parsing weapon animation file: %s", filename );<BR>return 
      qfalse;<BR>} <BR><BR>return qtrue;<BR>}<BR>// 
      END</FONT></FONT></FONT><FONT color=#ffffff><FONT 
      color=#00ff00><BR>----------------------------------------------------------------------</FONT><BR><BR><BR>Example 
      animation.cfg file:<BR><BR>0 20 0 22 // WP_ANIM_READY<BR>20 10 0 22 // 
      WP_ANIM_FIRE<BR><BR>The first number is the starting frame in the model, 
      the second number is the number of frames that animation runs for, the 
      third number is how many frames that animation is to repeat (Ive never 
      needed this so far, legs and such use this in the player animation files) 
      and the third is how many frames to play per second, I would keep this 
      fairly constant as big differences can cause some things to look 
      off.<BR><BR><B>STEP 5:</B><BR><BR>All right we have the frames and stuff 
      in but Coyote, we still dont have the model!! Well that is a bit trickier, 
      while you might not want to do this for every weapon, for the purposes of 
      this simple tutorial it is the easiest way. Just below in cg_weapons.c is 
      a function called CG_RegisterWeapon that we need to edit so that the 
      weapon model is added.<BR><BR><FONT color=#ff0000>Add to file: 
      cgame/cg_weapons.c<BR>Add to function: 
      CG_RegisterWeapon<BR></FONT><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR>void 
      CG_RegisterWeapon( int weaponNum ) {<BR>weaponInfo_t 
      *weaponInfo;<BR>gitem_t *item, *ammo;<BR>char path[MAX_QPATH]; <BR>vec3_t 
      mins, maxs;<BR><FONT color=#0000ff>// QUARANTINE - Weapon Animations - 
      Added Variable<BR>char filename[MAX_QPATH]; //Used to open animation.cfg 
      files<BR>// END</FONT><BR>int i;<BR><BR><BR>if ( ammo-&gt;classname 
      &amp;&amp; ammo-&gt;world_model[0] ) {<BR>weaponInfo-&gt;ammoModel = 
      trap_R_RegisterModel( ammo-&gt;world_model[0] );<BR>}<BR><BR><FONT 
      color=#0000ff>// QUARANTINE - Weapon Animations - Parse animation 
      files<BR><BR>/* This is where you can add support for all weapons, just 
      add<BR>additional cases for other weapons and copy the same code 
      and<BR>just change the file location of the animation.cfg<BR>*/<BR>switch 
      (weaponNum) {<BR>case WP_MACHINEGUN:<BR>Com_sprintf( filename, 
      sizeof(filename), <BR>"models/weapons2/machinegun/animation.cfg" );<BR>if 
      ( !CG_ParseWeaponAnimFile(filename, weaponInfo) ) {<BR>Com_Printf("Failed 
      to load weapon animation file %s\n", filename);<BR>}<BR>break;<BR>case 
      WP_SHOTGUN:<BR>Com_sprintf( filename, sizeof(filename), 
      <BR>"models/weapons2/shotgun/animation.cfg" );<BR>if ( 
      !CG_ParseWeaponAnimFile(filename, weaponInfo) ) {<BR>Com_Printf("Failed to 
      load weapon animation file %s\n", 
      filename);<BR>}<BR>break;<BR>}</FONT><BR><BR>strcpy( path, 
      item-&gt;world_model[0] );<BR>COM_StripExtension( path, path );<BR>strcat( 
      path, "_hand.md3" ); <BR>weaponInfo-&gt;handsModel = trap_R_RegisterModel( 
      path );<BR><BR><FONT color=#0000ff>// QUARANTINE - Weapon Animations - 
      Register models<BR>// Register the animation model into the 
      game<BR>strcpy( path, item-&gt;world_model[0] );<BR>COM_StripExtension( 
      path, path );<BR>strcat( path, "_anim.md3" ); // Animations 
      model<BR>weaponInfo-&gt;animModel = trap_R_RegisterModel( path );<BR>// 
      END</FONT><BR><BR>if ( !weaponInfo-&gt;handsModel ) 
      {<BR>weaponInfo-&gt;handsModel = trap_R_RegisterModel( 
      "models/weapons2/shotgun/shotgun_hand.md3" ); <BR>}<BR><BR><FONT 
      color=#0000ff>// Weapon Animations - So all weapons appear at a single 
      position<BR>weaponInfo-&gt;animHandModel = trap_R_RegisterModel( 
      "models/weapons2/shotgun/shotgun_hand.md3" );</FONT><FONT 
      color=#0000ff><BR></FONT><FONT 
      color=#00ff00>----------------------------------------------------------------------</FONT><BR><BR><B>STEP 
      6:</B><BR><BR>Hold in there, we still have a few more things to cover 
      before we are close to having a working animation system. Ok so we have 
      our models in, we have the frames that we want to use; now we need to be 
      able to advance the frames and display the model on the screen. For this 
      bit of code were going to open cgame/cg_players.c, it is in this file that 
      character animations are handled to and it is so much easier and to me 
      efficient to just use an animation system that is already working, so were 
      going to hook our weapon animation into the actual code that handles 
      character animation. Go down to where it has a big banner that declares 
      PLAYER ANIMATIONS and add in this code.<BR><BR><FONT color=#ff0000>Add in 
      file: cgame/cg_players.c</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR><FONT 
      color=#0000ff>/* [QUARANTINE] - Weapon 
      Animations<BR>===============<BR>CG_SetWeaponLerpFrame<BR><BR>may include 
      ANIM_TOGGLEBIT<BR>===============<BR>*/<BR>static void 
      CG_SetWeaponLerpFrame( clientInfo_t *ci, lerpFrame_t *lf, int newAnimation 
      ) {<BR>animation_t *anim;<BR><BR>lf-&gt;animationNumber = 
      newAnimation;<BR>newAnimation &amp;= ~ANIM_TOGGLEBIT;<BR><BR>if ( 
      newAnimation &lt; 0 || newAnimation &gt;= MAX_WEAPON_ANIMATIONS ) 
      {<BR>CG_Error( "Bad weapon animation number: %i", newAnimation 
      );<BR>}<BR><BR>anim = &amp;cg_weapons[cg.snap-&gt;ps.weapon].animations[ 
      newAnimation ];<BR><BR>lf-&gt;animation = anim;<BR>lf-&gt;animationTime = 
      lf-&gt;frameTime + anim-&gt;initialLerp;<BR><BR>if ( cg_debugAnim.integer 
      ) {<BR>CG_Printf( "Weapon Anim: %i\n", newAnimation );<BR>}<BR>}<BR>// 
      END</FONT><BR><FONT 
      color=#00ff00>----------------------------------------------------------------------</FONT><BR><BR>As 
      those that are observant will notice this function is for the most part a 
      copy of the function just below it called CG_SetLerpFrameAnimation, I have 
      simply added un code to access out animation structures and spit out debug 
      code and error code that states the animation is for weapons and not 
      characters.<BR><BR>Now scroll down a bit further and you will notice a 
      function called CG_RunLerpFrame, this function is the meat of the 
      animation system as it takes care of actually advancing through the 
      frames. It is also the function that is called to do it, so we have a 
      issue, how do we tell this function that the animation were calling is 
      going to be a weapon animation and not a character animation? Well there 
      are really quite a lot of ways of doing it but I found the easiest to be 
      to just add in a qboolean parameter and pass in true if it was a weapon 
      animation and false if it was not. Below are the lines of code to change 
      to accomplish this.<BR><BR><FONT color=#ff0000>Add in file: 
      cgame/cg_players.c<BR>Add to function: CG_RunLerpFrame</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------<BR><FONT 
      color=#0000ff>Before:<BR><FONT color=#ffffff>static void CG_RunLerpFrame( 
      clientInfo_t *ci, lerpFrame_t *lf, int newAnimation, float speedScale) 
      {</FONT><BR><BR>After:<BR>static void CG_RunLerpFrame( clientInfo_t *ci, 
      lerpFrame_t *lf, int newAnimation, float speedScale, qboolean weaponAnim ) 
      {</FONT><BR>----------------------------------------------------------------------</FONT><BR><BR>Also 
      need to change the parameters of where it is called <BR><FONT 
      color=#ff0000>Add in file: cgame/cg_players.c<BR>Add in functions: 
      CG_PlayerAnimation, CG_PlayerFlag</FONT><BR><BR>In both of these you need 
      to change the CG_RunLerpFrame parameters with a qfalse at the end of them. 
      There are three calls in CG_PlayerAnimation and one call in 
      CG_PlayerFlag.<BR><BR>Due to some confusion here, the lines of code that 
      must be changed are given below:<BR><FONT color=#ff0000>Inside 
      CG_PlayerAnimation:</FONT><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR><FONT 
      color=#0000ff>// QUARANTINE - Weapon Animation - Added qfalse to indicate 
      a none weapon animation<BR>CG_RunLerpFrame( ci, &amp;cent-&gt;pe.legs, 
      LEGS_TURN, speedScale, qfalse );<BR>} else {<BR>CG_RunLerpFrame( ci, 
      &amp;cent-&gt;pe.legs, cent-&gt;currentState.legsAnim, speedScale, qfalse 
      );<BR>}</FONT><BR>*legsOld = cent-&gt;pe.legs.oldFrame;<BR>*legs = 
      cent-&gt;pe.legs.frame;<BR>*legsBackLerp = 
      cent-&gt;pe.legs.backlerp;<BR><FONT color=#0000ff>// QUARANTINE - Weapon 
      Animation - Added qfalse to indicate a none weapon 
      animation<BR>CG_RunLerpFrame( ci, &amp;cent-&gt;pe.torso, 
      cent-&gt;currentState.torsoAnim, speedScale, qfalse );</FONT><BR>*torsoOld 
      = cent-&gt;pe.torso.oldFrame;<BR>*torso = 
      cent-&gt;pe.torso.frame;<BR>*torsoBackLerp = 
      cent-&gt;pe.torso.backlerp;<BR>}<BR><FONT 
      color=#00ff00>---------------------------------------------------------------------- 
      </FONT></FONT></P>
      <P><FONT color=#ff0000>Inside of CG_PlayerFlag:</FONT><FONT 
      color=#ffffff><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR>// 
      lerp the flag animation frames<BR>ci = &amp;cgs.clientinfo[ 
      cent-&gt;currentState.clientNum ];<BR><FONT color=#0000ff>// QUARANTINE - 
      Weapon Animation - Added qfalse to indicate a none weapon 
      animation<BR>CG_RunLerpFrame( ci, &amp;cent-&gt;pe.flag, flagAnim, 1, 
      qfalse );</FONT><BR>flag.oldframe = 
      cent-&gt;pe.flag.oldFrame;<BR>flag.frame = 
      cent-&gt;pe.flag.frame;<BR>flag.backlerp = 
      cent-&gt;pe.flag.backlerp;<BR><FONT 
      color=#00ff00>----------------------------------------------------------------------</FONT><BR><BR>Ok 
      now that we have our parameter listing changed so that we can tell it what 
      kind of animation were calling we need to use that parameter to do the 
      work. Change these lines of code.<BR><BR><FONT color=#ff0000>Add in file: 
      cgame/cg_players.c<BR>Add in function: CG_RunLerpFrame</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR><FONT 
      color=#0000ff>Before:<BR><FONT color=#ffffff>// see if the animation 
      sequence is switching<BR>if ( newAnimation != lf-&gt;animationNumber || 
      !lf-&gt;animation ) {<BR>CG_SetLerpFrameAnimation( ci, lf, newAnimation 
      );<BR>}</FONT><BR><BR>After:<BR>// QUARANTINE - Weapon Animation<BR>// 
      Check and see if the animation is switching and then check to see if it is 
      a weapon<BR>// animation or character and call the proper lerp frame 
      function<BR>if ( newAnimation != lf-&gt;animationNumber || 
      !lf-&gt;animation ) {<BR>if (weaponAnim) {<BR>CG_SetWeaponLerpFrame( ci, 
      lf, newAnimation );<BR>} else {<BR>CG_SetLerpFrameAnimation( ci, lf, 
      newAnimation );<BR>}<BR>}<BR>// END</FONT><BR><FONT 
      color=#00ff00>----------------------------------------------------------------------<BR></FONT><BR><BR><B>STEP 
      7:</B><BR><BR>Wow, that was a lot of additions in the last step, but dont 
      give up now, were almost there. Ok now we have to actually have a way of 
      calling the CG_RunLerpFrame because those that are observant would have 
      noticed that it is static and Id prefer to keep it that way, also we 
      havent finished with advancing the frames quite yet. While the 
      CG_RunLerpFrame does do a huge amount of work it is the following function 
      that makes it all possible. Scroll down inside of cgame/cg_players.c till 
      you get to the function CG_PlayerAnimation function. Just above that 
      function I want you to add in this code.<BR><BR><FONT color=#ff0000>Add in 
      file: cgame/cg_players.c</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR><FONT 
      color=#0000ff>/* [QUARANTINE] - Weapon 
      Animations<BR>===============<BR>CG_WeaponAnimation<BR><BR>This is called 
      from cg_weapons.c<BR>===============<BR>*/<BR>void CG_WeaponAnimation( 
      centity_t *cent, int *weaponOld, int *weapon, float *weaponBackLerp ) 
      {<BR>clientInfo_t *ci;<BR>int clientNum;<BR><BR>clientNum = 
      cent-&gt;currentState.clientNum;<BR><BR>if ( cg_noPlayerAnims.integer ) 
      {<BR>*weaponOld = *weapon = 0;<BR>return;<BR>}<BR><BR>ci = 
      &amp;cgs.clientinfo[ clientNum ];<BR><BR>CG_RunLerpFrame( ci, 
      &amp;cent-&gt;pe.weapon, cent-&gt;currentState.generic1, 1, qtrue 
      );<BR><BR>// QUARANTINE - Debug - Animations<BR>#if 
      0<BR>if(cent-&gt;pe.weapon.oldFrame || cent-&gt;pe.weapon.frame || 
      cent-&gt;pe.weapon.backlerp) {<BR>CG_Printf("weaponOld: %i weaponFrame: %i 
      weaponBack: %i\n", <BR>cent-&gt;pe.weapon.oldFrame, 
      cent-&gt;pe.weapon.frame, 
      cent-&gt;pe.weapon.backlerp);<BR>}<BR>#endif<BR><BR>*weaponOld = 
      cent-&gt;pe.weapon.oldFrame;<BR>*weapon = 
      cent-&gt;pe.weapon.frame;<BR>*weaponBackLerp = 
      cent-&gt;pe.weapon.backlerp;<BR><BR>}<BR>// END</FONT><BR><FONT 
      color=#00ff00>----------------------------------------------------------------------<BR></FONT><BR><FONT 
      color=#ff0000>Add in header: cgame/cg_local.h</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------<BR><FONT 
      color=#0000ff>void CG_WeaponAnimation( centity_t *cent, int *weaponOld, 
      int *weapon, float *weaponBackLerp 
      );</FONT><BR>----------------------------------------------------------------------</FONT><BR><BR><BR><BR>I 
      went ahead and left in the debug code there for those that might want to 
      be able to take a look at what frames it is calling as it works, be 
      forewarned that this will spew out a lot of text when you animate and is 
      not always helpful but it can be useful.<BR><BR>Another thing you might 
      want to notice about the code above is where it calls CG_RunLerpFrame 
      youll notice we pass in cent-&gt;currentState.generic1. generic1 is a 
      variable in the playerState_t and for the most part is only used in the 
      MISSIONPACK parts of the code. For me this is no problem, as I do not use 
      those parts of the code, however for others it might very well be. Just 
      remember that whatever variable you might want to replace it with it has 
      to be one that is transferred between the playerStat_t and the 
      entityStat_t as this is the variable that tells us what animation we 
      currently need to run.<BR><BR><BR><B>STEP 8:</B><BR>Now we need to add in 
      the call to CG_WeaponAnimation, which we just made. Inside of 
      cgame/cg_weapons.c there is a single function called CG_AddPlayerWeapon 
      that has a very important refrence in it that makes all this possible. 
      Whenever this function is adding the weapon to the player in third person 
      the ps variable (playerstate for those not in the know) is NULL, but when 
      it is adding the weapon to the first person it is valid so to determine 
      what we need to do when we just add in a few checks for the ps state and 
      then add in our functions.<BR><FONT color=#ff0000><BR>Add in file: 
      cgame/cg_weapons.c<BR>Add in function: 
      CG_AddPlayerWeapon</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR>/*<BR>=============<BR>CG_AddPlayerWeapon<BR><BR>Used 
      for both the view weapon (ps is valid) and the world modelother character 
      models (ps is NULL)<BR>The main player will have this called for BOTH 
      cases, so effects like light and sound should only be done on the world 
      model case.<BR>=============<BR>*/<BR>void CG_AddPlayerWeapon( refEntity_t 
      *parent, playerState_t *ps, centity_t *cent, int team ) {<BR>refEntity_t 
      gun;<BR>refEntity_t barrel;<BR>refEntity_t flash;<BR>vec3_t 
      angles;<BR>weapon_t weaponNum;<BR>weaponInfo_t *weapon;<BR>centity_t 
      *nonPredictedCent;<BR>// int col;<BR><BR>weaponNum = 
      cent-&gt;currentState.weapon;<BR><BR>CG_RegisterWeapon( weaponNum 
      );<BR>weapon = &amp;cg_weapons[weaponNum];<BR><BR>// add the 
      weapon<BR>memset( &amp;gun, 0, sizeof( gun ) );<BR>VectorCopy( 
      parent-&gt;lightingOrigin, gun.lightingOrigin );<BR>gun.shadowPlane = 
      parent-&gt;shadowPlane;<BR>gun.renderfx = parent-&gt;renderfx;<BR><BR>// 
      set custom shading for railgun refire rate<BR>if ( ps ) {<BR>if ( 
      cg.predictedPlayerState.weapon == WP_RAILGUN <BR>&amp;&amp; 
      cg.predictedPlayerState.weaponstate == WEAPON_FIRING ) {<BR>float 
      f;<BR><BR>f = (float)cg.predictedPlayerState.weaponTime / 
      1500;<BR>gun.shaderRGBA[1] = 0;<BR>gun.shaderRGBA[0] = 
      <BR>gun.shaderRGBA[2] = 255 * ( 1.0 - f );<BR>} else 
      {<BR>gun.shaderRGBA[0] = 255;<BR>gun.shaderRGBA[1] = 
      255;<BR>gun.shaderRGBA[2] = 255;<BR>gun.shaderRGBA[3] = 
      255;<BR>}<BR>}<BR><BR><FONT color=#0000ff>if ( ps ) {<BR>gun.hModel = 
      weapon-&gt;animModel;<BR>}<BR>else { <BR>gun.hModel = 
      weapon-&gt;weaponModel;<BR>}</FONT><BR><BR>if (!gun.hModel) 
      {<BR>return;<BR>}<BR><BR>if ( !ps ) {<BR>// add weapon ready 
      sound<BR>cent-&gt;pe.lightningFiring = qfalse;<BR>if ( ( 
      cent-&gt;currentState.eFlags &amp; EF_FIRING ) &amp;&amp; 
      weapon-&gt;firingSound ) {<BR>// lightning gun and guantlet make a 
      different sound when fire is held down<BR>trap_S_AddLoopingSound( 
      cent-&gt;currentState.number, cent-&gt;lerpOrigin, vec3_origin, 
      weapon-&gt;firingSound );<BR>cent-&gt;pe.lightningFiring = qtrue;<BR>} 
      else if ( weapon-&gt;readySound ) {<BR>trap_S_AddLoopingSound( 
      cent-&gt;currentState.number, cent-&gt;lerpOrigin, vec3_origin, 
      weapon-&gt;readySound );<BR>}<BR>}<BR><BR><FONT color=#0000ff>if ( !ps ) 
      {<BR>CG_PositionEntityOnTag( &amp;gun, parent, parent-&gt;hModel, 
      "tag_weapon");<BR>}<BR>else {<BR>CG_WeaponAnimation( cent, 
      &amp;gun.oldframe, &amp;gun.frame, &amp;gun.backlerp 
      );<BR>CG_PositionWeaponOnTag( &amp;gun, parent, parent-&gt;hModel, 
      "tag_weapon");<BR>} </FONT><BR><BR>CG_AddWeaponWithPowerups( &amp;gun, 
      cent-&gt;currentState.powerups );<BR><BR><BR>// add the spinning 
      barrel<BR><FONT color=#0000ff>// QUARANTINE - Animation - To prevent the 
      barrel from showing up in first person<BR>// If you want a spinning barrel 
      in first person, create a new if statement and<BR>// a different tag from 
      what is attached to the third world model.<BR>if ( weapon-&gt;barrelModel 
      &amp;&amp; !ps ) {</FONT><BR>memset( &amp;barrel, 0, sizeof( barrel ) 
      );<BR>VectorCopy( parent-&gt;lightingOrigin, barrel.lightingOrigin 
      );<BR>barrel.shadowPlane = parent-&gt;shadowPlane;<BR>barrel.renderfx = 
      parent-&gt;renderfx;<BR><BR>barrel.hModel = 
      weapon-&gt;barrelModel;<BR>angles[YAW] = 0;<BR>angles[PITCH] = 
      0;<BR>angles[ROLL] = CG_MachinegunSpinAngle( cent );<BR>AnglesToAxis( 
      angles, barrel.axis );<BR><BR>CG_PositionRotatedEntityOnTag( &amp;barrel, 
      &amp;gun, weapon-&gt;weaponModel, "tag_barrel" 
      );<BR><BR>CG_AddWeaponWithPowerups( &amp;barrel, 
      cent-&gt;currentState.powerups );<BR>}</FONT></P>
      <P><FONT color=#ffffff><FONT color=#0000ff>// QUARANTINE - Attach the 
      flash to the first person model as well as the external otherwise 
      you<BR>// you get a flash right in the middle of your screen<BR>if 
      (ps)<BR>CG_PositionRotatedEntityOnTag( &amp;flash, &amp;gun, 
      weapon-&gt;animModel, 
      "tag_flash");<BR>else<BR>CG_PositionRotatedEntityOnTag( &amp;flash, 
      &amp;gun, weapon-&gt;weaponModel, "tag_flash");</FONT><BR><FONT 
      color=#00ff00>----------------------------------------------------------------------</FONT><BR><BR>The 
      rest of the function is left alone. Now we need to talk about what we have 
      accomplished here. First youll notice that we have added the additional 
      checks on the ps state, these are not perfect, Im sure if you want to take 
      the time you can make them all go under a single comparison instead of 
      three or four. I myself actually separated the functions into one that 
      handles only third person and another that handles only first person. I 
      simply made it as simple as possible here for the tutorial.<BR><BR>In the 
      first check youll notice we give the gun variable our animation model that 
      we have stored. In the second comparison we advance along our animation by 
      calling our CG_WeaponAnimation and then youll notice that we call a new 
      function CG_PositionWeaponOnTag. This handles the positioning of the model 
      just a bit differently; step 9 shows why we add this function and where to 
      add it and what code to add.<BR><BR><BR><B>STEP 9:</B><BR><BR>In step 8 we 
      added in the code that handles drawing the models to the screen and we 
      found a function that we had not yet made called CG_PositionWeaponOnTag. 
      This function is actually just the same as the CG_PositionEntityOnTag 
      except for the removal of a single line of code.<BR><BR><BR><FONT 
      color=#ff0000>Add in file: cgame/cg_ents.c</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR><FONT 
      color=#0000ff>/* [QUARANTINE] - 
      CG_PositionWeaponOnTag<BR>======================<BR>CG_PositionWeaponOnTag</FONT></FONT></P>
      <P><FONT color=#0000ff>Changed from CG_PositionEntityOnTag function to 
      prevent backlerp change in 
      animations<BR>======================<BR>*/<BR>void CG_PositionWeaponOnTag( 
      refEntity_t *entity, const refEntity_t *parent, qhandle_t parentModel, 
      char *tagName ) {<BR>int i;<BR>orientation_t lerped;<BR><BR>// lerp the 
      tag<BR>trap_R_LerpTag( &amp;lerped, parentModel, parent-&gt;oldframe, 
      parent-&gt;frame,<BR>1.0 - parent-&gt;backlerp, tagName );<BR><BR>// 
      FIXME: allow origin offsets along tag?<BR>VectorCopy( parent-&gt;origin, 
      entity-&gt;origin );<BR>for ( i = 0 ; i &lt; 3 ; i++ ) {<BR>VectorMA( 
      entity-&gt;origin, lerped.origin[i], parent-&gt;axis[i], entity-&gt;origin 
      );<BR>}<BR><BR>// had to cast away the const to avoid compiler 
      problems...<BR>MatrixMultiply( lerped.axis, ((refEntity_t 
      *)parent)-&gt;axis, entity-&gt;axis );<BR>// entity-&gt;backlerp = 
      parent-&gt;backlerp;<BR>}</FONT><FONT color=#ffffff><BR><FONT 
      color=#00ff00>----------------------------------------------------------------------<BR></FONT><BR><FONT 
      color=#ff0000>Add in header: cgame/cg_local.h</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------<BR><FONT 
      color=#0000ff>void CG_PositionWeaponOnTag( refEntity_t *entity, const 
      refEntity_t *parent, qhandle_t parentModel, char *tagName 
      );</FONT><BR>----------------------------------------------------------------------</FONT><BR><BR><BR>As 
      you can see this is identical except for commenting out one line. Why 
      comment out one line of code? Well that is because that one line of code 
      messes with the backlerp frames of the entity being passed in and if we 
      allowed that to happen with our animation model our animations would be 
      off, therefore we had to create this function to prevent that from 
      happening.<BR><BR><B>STEP 10:</B><BR><BR>All right stop panting were 
      getting close now. We have all the basics of the underlining system that 
      will do the hard work for us; we now need to add in the functions and the 
      code that will actually tell this code what animation to play. Open up 
      game/bg_pmove.c as this is where most of the animation code for running, 
      and firing in third person is handled it is also the proper place to be 
      handling the animations for our first person stuff. As with other steps 
      lets present the code we need to add and then explain what is happening. 
      Another note on this section of code. Be sure and add it to the beginning 
      of the file, I have had several people email me with errors saying these 
      functions are not defined and it usually is because they added them to the 
      end of the file.<BR><FONT color=#ff0000><BR>Add in file: 
      game/bg_pmove.c</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------<BR><FONT 
      color=#0000ff>/* [QUARANTINE] - Weapon 
      Animations<BR>===================<BR>PM_StartWeaponAnim, 
      PM_ContinueWeaponAnim<BR>===================<BR>*/<BR>static void 
      PM_StartWeaponAnim( int anim ) {<BR>if ( pm-&gt;ps-&gt;pm_type &gt;= 
      PM_DEAD ) {<BR>return;<BR>}<BR><BR>pm-&gt;ps-&gt;generic1 = ( ( 
      pm-&gt;ps-&gt;generic1 &amp; ANIM_TOGGLEBIT ) ^ ANIM_TOGGLEBIT ) | 
      anim;<BR>}<BR><BR>static void PM_ContinueWeaponAnim( int anim ) {<BR>if ( 
      ( pm-&gt;ps-&gt;generic1 &amp; ~ANIM_TOGGLEBIT ) == anim ) 
      {<BR>return;<BR>}<BR><BR>PM_StartWeaponAnim( anim );<BR>}<BR>// 
      END</FONT><BR>----------------------------------------------------------------------</FONT><BR><BR><BR>Not 
      much code, uh? Well it is with the simplicity of these two functions that 
      were going to handle telling the code what animation to play. Notice, that 
      what were setting with the PM_StartWeaponAnim function is the generic1 
      variable. Remember us talking about it back in step 7, this is the 
      variable that is checked to see if weve switched animations, as I told 
      you, this is the key to making this work so fluently. Another thing to 
      note is that these functions are identical to the torso animation 
      functions except for the priority animation checking, you have to use up a 
      variable in your playerstate_t to enable this ability and would be of use 
      in reloads or draws if you wished to make sure that those types of 
      animations finished before another animation would play. Now, on to the 
      next step to learn where to place the calls to these functions so as to 
      enable fire animation.<BR><BR><B>STEP 11:</B><BR><BR>Well this is the 
      final step, we simple have to place in a few calls to our previous 
      functions to change the animations on the weapons and were 
      finished.<BR><BR><FONT color=#ff0000>Add in file: game/bg_pmove.c<BR>Add 
      in function: PM_TorsoAnimation</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------<BR><FONT 
      color=#ffffff>static void PM_TorsoAnimation( void ) {<BR>if ( 
      pm-&gt;ps-&gt;weaponstate == WEAPON_READY ) {<BR>if ( pm-&gt;ps-&gt;weapon 
      == WP_GAUNTLET ) {<BR>PM_ContinueTorsoAnim( TORSO_STAND2 );<BR>} else { 
      <BR>PM_ContinueTorsoAnim( TORSO_STAND );<BR>}<BR><BR><FONT 
      color=#0000ff>// QUARANTINE - Weapon Animation<BR>// Should always draw 
      the weapon when it is just ready<BR>PM_ContinueWeaponAnim( WP_ANIM_READY 
      );</FONT><BR>return;<BR>}<BR>}</FONT><BR>----------------------------------------------------------------------</FONT><BR><BR><FONT 
      color=#ff0000>Add in file: game/bg_pmove.c<BR>Add in function: 
      PM_Weapon</FONT><BR><BR><FONT 
      color=#00ff00>Code:<BR>----------------------------------------------------------------------</FONT><BR><BR>if 
      ( pm-&gt;ps-&gt;weaponstate == WEAPON_RAISING ) 
      {<BR>pm-&gt;ps-&gt;weaponstate = WEAPON_READY;<BR>if ( 
      pm-&gt;ps-&gt;weapon == WP_GAUNTLET ) {<BR>PM_StartTorsoAnim( TORSO_STAND2 
      );<BR>} else {<BR>PM_StartTorsoAnim( TORSO_STAND );<BR>}<BR><FONT 
      color=#0000ff>// QUARANTINE - Weapon Animation<BR>// Should always draw 
      the weapon when it is just ready<BR>PM_StartWeaponAnim( WP_ANIM_READY 
      );</FONT><BR>return;<BR>}<BR><BR>// check for fire<BR>if ( ! 
      (pm-&gt;cmd.buttons &amp; BUTTON_ATTACK) ) {<BR>pm-&gt;ps-&gt;weaponTime = 
      0;<BR>pm-&gt;ps-&gt;weaponstate = WEAPON_READY;<BR>return;<BR>}<BR><BR>// 
      start the animation even if out of ammo<BR>if ( pm-&gt;ps-&gt;weapon == 
      WP_GAUNTLET ) {<BR>// the guantlet only "fires" when it actually hits 
      something<BR>if ( !pm-&gt;gauntletHit ) {<BR>pm-&gt;ps-&gt;weaponTime = 
      0;<BR>pm-&gt;ps-&gt;weaponstate = 
      WEAPON_READY;<BR>return;<BR>}<BR>PM_StartTorsoAnim( TORSO_ATTACK2 );<BR>} 
      else {<BR>PM_StartTorsoAnim( TORSO_ATTACK );<BR>}<BR><BR><FONT 
      color=#0000ff>// QUARANTINE - Weapon animations<BR>// This should change 
      pm-&gt;ps-&gt;generic1 so we can animate<BR>PM_StartWeaponAnim( 
      WP_ANIM_FIRE );</FONT><BR>pm-&gt;ps-&gt;weaponstate = 
      WEAPON_FIRING;<BR><FONT 
      color=#00ff00>----------------------------------------------------------------------</FONT><BR><BR><BR>As 
      you can see all we are doing is calling our animation functions that we 
      declared at the top of the game/bg_pmove.c file and pass in the enumerated 
      data type that we had declared earlier. Adding in additional animations to 
      this system is as easy as adding in another definition, adding in the 
      frames to a model, changing the animation.cfg of that model and then 
      calling the animation where needed with these same functions, though as 
      you will notice our functions are static which prevents them from being 
      called outside of the bg_pmove.c file.<BR><BR>Well I hope this helps you 
      out in your production of a Quake 3 modification. I have provided this 
      tutorial in the hopes that it will get some people off to a good start and 
      give me the opportunity to play some game that a person might come up 
      with. All I ask is that if you do use this code in your Mod please, drop 
      me an email let me know and give me props for helping you 
      out.<BR><BR><B><I><FONT color=#ff8080>This has been a tutorial by 
      quarantinemod.net<BR>Coyote -Lead Programmer<BR>Quarantine (A Quake 3 
      Total 
Conversion)</FONT></I></B><BR></FONT></P></TD></TR></TBODY></TABLE></BODY></HTML>
