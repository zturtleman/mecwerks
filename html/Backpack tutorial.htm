<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0044)http://qwfix.quake3world.com/t_backpack.html -->
<HTML><HEAD><TITLE>qwFix - Backpack tutorial</TITLE>
<META content="text/html; charset=windows-1252" http-equiv=Content-Type>
<STYLE>A {
	COLOR: rgb(170,170,190)
}
A:link {
	rgb(170,170,190): 
}
A:visited {
	COLOR: rgb(170,170,190)
}
A:active {
	COLOR: rgb(170,170,190)
}
.menu {
	COLOR: rgb(170,170,190); TEXT-DECORATION: none
}
.menu:link {
	COLOR: rgb(170,170,190); TEXT-DECORATION: none
}
.menu:visited {
	COLOR: rgb(170,170,190); TEXT-DECORATION: none
}
.menu:active {
	COLOR: rgb(170,170,190); TEXT-DECORATION: none
}
.menu:hover {
	COLOR: red; TEXT-DECORATION: none
}
.alt {
	TEXT-DECORATION: underline; rgb(170,170,190): 
}
.alt:link {
	COLOR: rgb(170,170,190); TEXT-DECORATION: underline
}
.alt:visited {
	TEXT-DECORATION: underline; rgb(170,170,190): 
}
.alt:active {
	TEXT-DECORATION: underline; rgb(170,170,190): 
}
.alt:hover {
	TEXT-DECORATION: underline; rgb(170,170,190): 
}
TD {
	COLOR: rgb(180,180,180); FONT-FAMILY: verdana; FONT-SIZE: 12px
}
.small {
	COLOR: rgb(180,180,180); FONT-FAMILY: verdana; FONT-SIZE: 10px
}
.alt {
	
}
</STYLE>

<SCRIPT language=javascript src="Backpack tutorial_files/script.js">
	</SCRIPT>

<META content="MSHTML 5.00.2314.1000" name=GENERATOR></HEAD>
<BODY bgColor=#000923>
<TABLE>
  <TBODY>
  <TR>
    <TD colSpan=3>
      <TABLE>
        <TBODY>
        <TR>
          <TD><IMG align=left height=60 
            src="Backpack tutorial_files/logo2.gif" width=341> &nbsp;&nbsp; <A 
            href="http://qwfix.quake3world.com/event.ng/Type=click&amp;ProfileID=1029&amp;RunID=2829&amp;AdID=1845&amp;GroupID=57&amp;FamilyID=1&amp;TagValues=2647.2657.3037.3043.3048&amp;Redirect=http://adforce.imgis.com/?adlink|34|80724|1|1|MISC=2000.4.12.19.15.43.0;"><IMG 
            alt="Click Here!" border=1 height=60 
            src="Backpack tutorial_files/Ad181948St1Sz1Sq1Id1.gif" 
            width=468><BR><TT><B>Click Here!</B></TT></A> </TD></TR>
        <TR>
          <TD>&nbsp; </TD></TR></TBODY></TABLE></TD></TR>
  <TR>
    <TD height=* vAlign=top>
      <TABLE cellPadding=0 cellSpacing=0 width=138>
        <TBODY>
        <TR>
          <TD><IMG src="Backpack tutorial_files/topmenu.gif"> </TD></TR>
        <TR>
          <TD background="Backpack tutorial_files/bgmenu.gif"><BR><FONT 
            face=verdana>&nbsp;&nbsp;&nbsp;<FONT 
            color=#e5e5c0>qwFix:</FONT><BR><BR>&nbsp;&nbsp;&nbsp;<A class=menu 
            href="http://qwfix.quake3world.com/index.html">News</A><BR><BR>&nbsp;&nbsp;&nbsp;<A 
            class=menu 
            href="http://qwfix.quake3world.com/mods.html">Mods</A><BR>&nbsp;&nbsp;&nbsp;<A 
            class=menu 
            href="http://qwfix.quake3world.com/maps.html">Maps</A><BR>&nbsp;&nbsp;&nbsp;<A 
            class=menu 
            href="http://qwfix.quake3world.com/demos.html">Demos</A><BR><BR>&nbsp;&nbsp;&nbsp;<A 
            class=menu 
            href="http://qwfix.quake3world.com/board.html">Board</A><BR>&nbsp;&nbsp;&nbsp;<A 
            class=menu 
            href="http://qwfix.quake3world.com/contact.html">Contact</A><BR>&nbsp;&nbsp;&nbsp;<A 
            class=menu 
            href="http://qwfix.quake3world.com/faq.html">FAQ</A><BR>&nbsp;&nbsp;&nbsp;<A 
            class=menu 
            href="http://qwfix.quake3world.com/issues.html">Notes</A><BR><BR>&nbsp;&nbsp;&nbsp;<FONT 
            color=#e5e5c0>Tutorials:</FONT><BR><BR>&nbsp;&nbsp;&nbsp;<A 
            class=menu 
            href="http://qwfix.quake3world.com/t_backpack.html">Backpacks</A><BR>&nbsp;&nbsp;&nbsp;<A 
            class=menu href="http://qwfix.quake3world.com/t_rail.html">Rail 
            Color</A><BR><BR>&nbsp;&nbsp;&nbsp;<A class=menu 
            href="http://qwfix.quake3world.com/t_other.html">Other</A><BR><BR></FONT></TD></TR>
        <TR>
          <TD><IMG src="Backpack tutorial_files/bottommenu.gif"> 
      </TD></TR></TBODY></TABLE></TD>
    <TD vAlign=top>
      <TABLE cellPadding=2 height=*><! *** POST STARTS*** >
        <TBODY>
        <TR>
          <TD 
            background="Backpack tutorial_files/bgnewsbar2.gif">&nbsp;&nbsp;&nbsp;&nbsp; 
            <B><FONT color=#c0c0c0 face=verdana>BACKPACK TUTORIAL - READ THIS 
            FIRST </FONT></B></TD></TR>
        <TR>
          <TD><FONT face=verdana><BR><B>"Copyright" notice</B><BR>You are 
            allowed to use the code in this tutorial in any way you like, as 
            long you give me at least some credit for the work I've 
            done.<BR><BR><B>Disclaimer</B><BR>I am not responsible for any 
            direct or indirect damage caused by this tutorial. Use it at your 
            own risk.<BR><BR><B>I DO NOT GET PAID TO DO THIS!</B><BR><BR>&nbsp; 
            </FONT></TD></TR><! *** POST ENDS *** ><! *** POST STARTS*** >
        <TR>
          <TD 
            background="Backpack tutorial_files/bgnewsbar2.gif">&nbsp;&nbsp;&nbsp;&nbsp; 
            <B><FONT color=#c0c0c0 face=verdana>STEP 1: Creating the necessary 
            resources </FONT></B></TD></TR>
        <TR>
          <TD><FONT face=verdana>First, you'll need a backpack model and a 
            backpack icon. The backpack model in qwFix is, indirectly, a 
            copyright of Jason 'Fireball' Verkaart, so don't use it without 
            asking. The backpack icon in qwFix may be used and altered freely, 
            though.<BR><BR>When you've created the model and the icon, place the 
            resources in the following directories:<BR>The model: 
            yourQ3modpath\models<BR>The icon: yourQ3modpath\icons<BR><BR>Now 
            you'll need a shader for the backpack icon, or else it will show 
            "through walls". Create a file named "backpack.shader" and place it 
            in "yourQ3modpath\scripts". The shader should include the following 
            lines:<BR><BR><FONT 
            color=#e5e5c0>icons/icon_backpack<BR>{<BR>&nbsp;&nbsp;&nbsp;nopicmip<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map 
            icons/icon_backpack.tga<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blendFunc 
            GL_SRC_ALPHA 
            GL_ONE_MINUS_SRC_ALPHA<BR>&nbsp;&nbsp;&nbsp;}<BR>}<BR></FONT><BR>I'm 
            not a shader expert, but that will get the job done. Of course, you 
            should "map" the correct icon, if you've named it anything else than 
            "icon_backpack.tga".<BR><BR>&nbsp; </FONT></TD></TR><! *** POST ENDS *** ><! *** POST STARTS*** >
        <TR>
          <TD 
            background="Backpack tutorial_files/bgnewsbar2.gif">&nbsp;&nbsp;&nbsp;&nbsp; 
            <B><FONT color=#c0c0c0 face=verdana>STEP 2: Adding the backpack item 
            to the itemlist </FONT></B></TD></TR>
        <TR>
          <TD><FONT face=verdana>Now we'll dig into the code. To get the new 
            item working correctly, we need to add it to the Big List of Items. 
            But before we can do that, we'll have to define how q3 is going to 
            define a backpack.<BR><BR>There's lots of possibilites, but I chose 
            to make the backpack a "weapon". If you like, you could make the 
            backpack a powerup instead (or a completely new type, for that 
            matter), but this tutorial assumes the "weapon" solution is 
            used.<BR><BR>Now open the file "bg_public.h" and search for 
            "WP_NUM_WEAPONS". You should find a enum structure with all the WP_ 
            definitions. Then, just above the WP_NUM_WEAPONS (but below 
            WP_GRAPPLING_HOOK), add this line:<BR><BR><FONT 
            color=#e5e5c0>WP_BACKPACK,</FONT><BR><BR>Save and close 
            "bg_public.h" and open "bg_misc.c" instead. Search for 
            "team_CTF_redflag" and you'll find a structure defining what 
            model/icon the red flag should use. Now add these lines above the 
            flag structure (below the flight powerup structure):<BR><BR><FONT 
            color=#e5e5c0>{<BR>&nbsp;&nbsp;&nbsp;"weapon_backpack",<BR>&nbsp;&nbsp;&nbsp;"sound/misc/w_pkup.wav",<BR>&nbsp;&nbsp;&nbsp;{ 
            "models/backpack.md3", 0, 0, 
            0},<BR>&nbsp;&nbsp;&nbsp;"icons/icon_backpack",<BR>&nbsp;&nbsp;&nbsp;"Backpack",<BR>&nbsp;&nbsp;&nbsp;0,<BR>&nbsp;&nbsp;&nbsp;IT_WEAPON,<BR>&nbsp;&nbsp;&nbsp;WP_BACKPACK,<BR>&nbsp;&nbsp;&nbsp;"",<BR>&nbsp;&nbsp;&nbsp;""<BR>},<BR></FONT><BR>Now 
            it is added. Now there are one of thing to remember... If a player 
            who doesn't have your client-side code installed connects to your 
            server, he will be kicked out if the gametype is CTF. Why? Because 
            the flags will be located in item index positions that he won't 
            have.<BR><BR>&nbsp; </FONT></TD></TR><! *** POST ENDS *** ><! *** POST STARTS*** >
        <TR>
          <TD 
            background="Backpack tutorial_files/bgnewsbar2.gif">&nbsp;&nbsp;&nbsp;&nbsp; 
            <B><FONT color=#c0c0c0 face=verdana>STEP 3: Dropping the backpack 
            when a player dies </FONT></B></TD></TR>
        <TR>
          <TD><FONT face=verdana>Now you want people to drop the damn 
            backpacks, right? This requires some hacking because we don't want 
            to change the entity structure (it is already large enough). So how 
            are we going to save all ammo information in an entity that hasn't 
            got enough data fields?<BR><BR>Well this can be solved with some bit 
            operations. As you know, each weapon has a maximum ammo count of 200 
            rounds. 200 in hex is C8 and 11001000 binary. If you count the bits, 
            you'll notice their eight of them. Almost every field in the entity 
            structure are integers (int). An integer can hold 16 bits (actually, 
            I believe the ANSI C code defines "int" as 32 bit, <A class=alt 
            href="mailto:khaile@www.com">email me</A> if you know for sure), 
            which is enough to hold <B>two</B> ammo types.<BR><BR>Now, to put 
            two ammo types into the same field, you must use bitwise shift 
            operations. Basically, it looks like this:<BR><BR><FONT 
            color=#e5e5c0>[Data Field] = (([Ammo1] &amp; 0x00FF) &lt;&lt; 8) + 
            ([Ammo2] &amp; 0x00FF);<BR></FONT><BR>But first, we must drop the 
            backpack... Open "g_combat.c" and search for "toss". You will find a 
            function named "TossClientItems". This function is called when the 
            player has died and it's time to drop the items he was carrying. 
            Find the large if-statement block, starting with this 
            line:<BR><BR><FONT color=#e5e5c0>if ( weapon &gt; WP_MACHINEGUN 
            &amp;&amp; weapon != WP_GRAPPLING_HOOK 
            &amp;&amp;<BR></FONT><BR>Remove the complete if-block (or just place 
            it in a comment). Then add the new backpack code:<BR><BR>// find the 
            item type for the backpack<BR><FONT color=#e5e5c0>item = 
            BG_FindItemForWeapon(WP_BACKPACK);<BR></FONT>// spawn the 
            backpack<BR><FONT color=#e5e5c0>drop = Drop_Item( self, item, 0 
            );<BR></FONT>// fill the backpack with the player's weapon 
            information:<BR>// count is used for weapon info, damage for MG-ammo 
            and SG-ammo,<BR>// health for GL-ammo and RL-ammo, splashdamage for 
            LG-ammo and<BR>// RAIL-ammo, and splashradius for PLASMA and 
            BFG-ammo<BR><FONT color=#e5e5c0>drop-&gt;count = 
            weapon;<BR>drop-&gt;damage = 
            <BR>&nbsp;&nbsp;&nbsp;((self-&gt;client-&gt;ps.ammo[WP_MACHINEGUN] 
            &amp; 0x00FF) &lt;&lt; 8) 
            +<BR>&nbsp;&nbsp;&nbsp;(self-&gt;client-&gt;ps.ammo[WP_SHOTGUN] 
            &amp; 0x00FF);<BR>drop-&gt;health = 
            <BR>&nbsp;&nbsp;&nbsp;((self-&gt;client-&gt;ps.ammo[WP_GRENADE_LAUNCHER] 
            &amp; 0x00FF) &lt;&lt; 8) 
            +<BR>&nbsp;&nbsp;&nbsp;(self-&gt;client-&gt;ps.ammo[WP_ROCKET_LAUNCHER] 
            &amp; 0x00FF);<BR>drop-&gt;splashDamage = 
            <BR>&nbsp;&nbsp;&nbsp;((self-&gt;client-&gt;ps.ammo[WP_LIGHTNING] 
            &amp; 0x00FF) &lt;&lt; 8) 
            +<BR>&nbsp;&nbsp;&nbsp;(self-&gt;client-&gt;ps.ammo[WP_RAILGUN] 
            &amp; 0x00FF);<BR>drop-&gt;splashRadius = 
            <BR>&nbsp;&nbsp;&nbsp;((self-&gt;client-&gt;ps.ammo[WP_PLASMAGUN] 
            &amp; 0x00FF) &lt;&lt; 8) 
            +<BR>&nbsp;&nbsp;&nbsp;(self-&gt;client-&gt;ps.ammo[WP_BFG] &amp; 
            0x00FF);<BR></FONT><BR>As you can see, I use the damage, health, 
            splashdamage and splashradius data fields to keep the ammo 
            information. This is all it takes to drop the backpack. Now we must 
            be able to pick it up, too.<BR><BR>&nbsp; </FONT></TD></TR><! *** POST ENDS *** ><! *** POST STARTS*** >
        <TR>
          <TD 
            background="Backpack tutorial_files/bgnewsbar2.gif">&nbsp;&nbsp;&nbsp;&nbsp; 
            <B><FONT color=#c0c0c0 face=verdana>STEP 4: Making it possible to 
            pick up the backpacks </FONT></B></TD></TR>
        <TR>
          <TD><FONT face=verdana>As a final step you must open "g_items.c" and 
            change the Pickup_Weapon function. Look for the first if 
            statement:<BR><BR><FONT color=#e5e5c0>if ( ent-&gt;count &lt; 0 ) 
            {<BR></FONT><BR>BEFORE that line, add this code:<BR><BR>// if it is 
            a backpack that has been picked up...<BR><FONT color=#e5e5c0>if 
            (ent-&gt;item-&gt;giTag == 
            WP_BACKPACK)<BR>{<BR>&nbsp;&nbsp;&nbsp;</FONT>// give the player the 
            backpack's weapon, if it isn't an gauntlet or a 
            machinegun<BR>&nbsp;&nbsp;&nbsp;<FONT color=#e5e5c0>if ( 
            ent-&gt;count &gt; WP_MACHINEGUN &amp;&amp; ent-&gt;count != 
            WP_GRAPPLING_HOOK)<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other-&gt;client-&gt;ps.stats[STAT_WEAPONS] 
            |= ( 1 &lt;&lt; ent-&gt;count 
            );<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;</FONT>// give the 
            player lots of ammo (sort of...)<BR>&nbsp;&nbsp;&nbsp;<FONT 
            color=#e5e5c0>Add_Ammo( other, WP_MACHINEGUN, (ent-&gt;damage 
            &gt;&gt; 8) );<BR>&nbsp;&nbsp;&nbsp;Add_Ammo( other, WP_SHOTGUN, 
            (ent-&gt;damage &amp; 0x00FF) );<BR>&nbsp;&nbsp;&nbsp;Add_Ammo( 
            other, WP_GRENADE_LAUNCHER, (ent-&gt;health &gt;&gt; 8) 
            );<BR>&nbsp;&nbsp;&nbsp;Add_Ammo( other, WP_ROCKET_LAUNCHER, 
            (ent-&gt;health &amp; 0x00FF) );<BR>&nbsp;&nbsp;&nbsp;Add_Ammo( 
            other, WP_LIGHTNING, (ent-&gt;splashDamage &gt;&gt; 8) 
            );<BR>&nbsp;&nbsp;&nbsp;Add_Ammo( other, WP_RAILGUN, 
            (ent-&gt;splashDamage &amp; 0x00FF) 
            );<BR>&nbsp;&nbsp;&nbsp;Add_Ammo( other, WP_PLASMAGUN, 
            (ent-&gt;splashRadius &gt;&gt; 8) );<BR>&nbsp;&nbsp;&nbsp;Add_Ammo( 
            other, WP_BFG, (ent-&gt;splashRadius &amp; 0x00FF) 
            );<BR>}<BR>else</FONT> // a normal weapon (ie not a 
            backpack)<BR><FONT color=#e5e5c0>{<BR></FONT><BR>And as a final 
            touch, add a single bracket ( } ) AFTER this line to maintain 
            correct code:<BR><BR><FONT color=#e5e5c0>quantity = 1; </FONT>// 
            only add a single shot<BR><BR>&nbsp; </FONT></TD></TR><! *** POST ENDS *** ><! *** POST STARTS*** >
        <TR>
          <TD 
            background="Backpack tutorial_files/bgnewsbar2.gif">&nbsp;&nbsp;&nbsp;&nbsp; 
            <B><FONT color=#c0c0c0 face=verdana>STEP 5: Registering the backpack 
            </FONT></B></TD></TR>
        <TR>
          <TD><FONT face=verdana>Before the backpack can be used, it must be 
            registered (so it can be precached). Find the "ClearRegisteredItems" 
            function in "g_items.c". And add the following line in the end of 
            the function:<BR><BR><FONT color=#e5e5c0>RegisterItem( 
            BG_FindItemForWeapon(WP_BACKPACK));<BR></FONT><BR><BR>That's it! 
            Contact me for suggestions and comments, I check <A class=alt 
            href="http://www.quake3world.com/cgi-bin/forumdisplay.cgi?action=topics&amp;forum=qwFix&amp;number=17">the 
            board</A> every day<BR><BR>// KHAILE <BR>&nbsp; </FONT></TD></TR><! *** POST ENDS *** ></TBODY></TABLE></TD>
    <TD vAlign=top>
      <TABLE cellPadding=0 cellSpacing=0 width=300>
        <TBODY>
        <TR>
          <TD><IMG src="Backpack tutorial_files/topnews.gif"> </TD></TD>
        <TR>
          <TD background="Backpack tutorial_files/bgnewsbar.gif" class=small 
          width=295><FONT color=#c0c0c0 face=verdana 
            size=2><B>&nbsp;&nbsp;Backpack tutorial info</FONT>
            <P></B><! *** POST STARTS *** ><FONT color=#c0c0c0 face=verdana 
            size=1><FONT color=#9090b0>&nbsp;&nbsp;&nbsp;Last modified: 11 
            feb</FONT><BR><! *** POST ENDS *** >
            <P><! *** POST STARTS *** ><FONT color=#c0c0c0 face=verdana 
            size=1><FONT 
            color=#9090b0>&nbsp;&nbsp;&nbsp;General:</FONT><BR>&nbsp;Requires a 
            client download: YES<BR>&nbsp;Requires new gfx/mdl's: 
            YES<BR>&nbsp;Modifies cgame: YES<BR>&nbsp;Modifies game: 
            YES<BR>&nbsp;Modifies ui: NO <! *** POST ENDS *** >
            <P><! *** POST STARTS *** ><FONT color=#c0c0c0 face=verdana 
            size=1><FONT color=#9090b0>&nbsp;&nbsp;&nbsp;Modified 
            files:</FONT><BR>&nbsp;bg_misc.c<BR>&nbsp;g_combat.c<BR>&nbsp;g_items.c<BR>&nbsp;bg_public.h<BR><! *** POST ENDS *** ><BR>&nbsp; 
            </FONT></P></FONT></FONT></TD></TR>
        <TR>
          <TD><IMG src="Backpack tutorial_files/bottomnews.gif"> 
      </TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></BODY></HTML>
